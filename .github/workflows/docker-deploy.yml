name: ðŸ³ Docker Build and Deploy

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  # é•œåƒä»“åº“é…ç½®
  IMAGE_NAME: ai-agent-platform
  
  # Docker Hubé…ç½®ï¼ˆæŽ¨èï¼Œå…è´¹ï¼‰
  DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
  
  # è…¾è®¯äº‘é•œåƒä»“åº“é…ç½®ï¼ˆå¯é€‰ï¼‰
  TCR_REGISTRY: ccr.ccs.tencentyun.com
  TCR_NAMESPACE: ${{ secrets.TCR_NAMESPACE }}
  
  # é˜¿é‡Œäº‘é•œåƒä»“åº“é…ç½®ï¼ˆå¯é€‰ï¼‰
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

jobs:
  build-and-push:
    name: ðŸ”¨ Build and Push Docker Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: ðŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸ·ï¸ Generate Docker Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}
          ${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ env.IMAGE_NAME }}
          ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value={{date 'YYYYMMDD-HHmm'}}
    
    - name: ðŸ”§ Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: ðŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ” Login to Docker Hub
      if: github.event_name != 'pull_request' && env.DOCKER_HUB_USERNAME != ''
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
        
    - name: ðŸ” Login to Tencent Cloud Registry
      if: github.event_name != 'pull_request' && secrets.TCR_USERNAME != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ env.TCR_REGISTRY }}
        username: ${{ secrets.TCR_USERNAME }}
        password: ${{ secrets.TCR_PASSWORD }}
        
    - name: ðŸ” Login to Aliyun Registry
      if: github.event_name != 'pull_request' && secrets.ALIYUN_USERNAME != ''
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ALIYUN_REGISTRY }}
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_PASSWORD }}
    
    - name: ðŸ“¦ Build and Push Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./deploy/docker/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VCS_REF=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}
    
    - name: ðŸ“Š Image Summary
      run: |
        echo "### Docker Image Build Summary ðŸ³" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY

  deploy-to-server:
    name: ðŸš€ Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ðŸš€ Deploy to Tencent Cloud Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          set -e
          echo "ðŸš€ Starting Docker deployment..."
          
          # å®šä¹‰å˜é‡ - ä¼˜å…ˆä½¿ç”¨Docker Hubï¼Œå…¶æ¬¡é˜¿é‡Œäº‘ï¼Œæœ€åŽè…¾è®¯äº‘
          CONTAINER_NAME="${{ env.IMAGE_NAME }}"
          
          if [ "${{ env.DOCKER_HUB_USERNAME }}" != "" ]; then
            IMAGE_TAG="${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
            echo "ðŸ” Logging in to Docker Hub..."
            echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ env.DOCKER_HUB_USERNAME }}" --password-stdin
          elif [ "${{ secrets.ALIYUN_USERNAME }}" != "" ]; then
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
            echo "ðŸ” Logging in to Aliyun Registry..."
            echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login -u "${{ secrets.ALIYUN_USERNAME }}" --password-stdin ${{ env.ALIYUN_REGISTRY }}
          elif [ "${{ secrets.TCR_USERNAME }}" != "" ]; then
            IMAGE_TAG="${{ env.TCR_REGISTRY }}/${{ env.TCR_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
            echo "ðŸ” Logging in to Tencent Cloud Registry..."
            echo "${{ secrets.TCR_PASSWORD }}" | docker login -u "${{ secrets.TCR_USERNAME }}" --password-stdin ${{ env.TCR_REGISTRY }}
          else
            echo "âŒ No registry credentials found! Please configure Docker Hub, Aliyun or Tencent Cloud credentials."
            exit 1
          fi
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "ðŸ“¥ Pulling latest image..."
          docker pull $IMAGE_TAG
          
          # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          echo "ðŸ›‘ Stopping old container..."
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          
          # åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          mkdir -p /opt/${{ env.IMAGE_NAME }}/data
          mkdir -p /opt/${{ env.IMAGE_NAME }}/uploads
          
          # è¿è¡Œæ–°å®¹å™¨
          echo "ðŸš€ Starting new container..."
          docker run -d \
            --name $CONTAINER_NAME \
            -p 3000:3000 \
            --restart unless-stopped \
            -v /opt/${{ env.IMAGE_NAME }}/data:/app/data \
            -v /opt/${{ env.IMAGE_NAME }}/uploads:/app/public/uploads \
            -e NODE_ENV=production \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e REDIS_URL="${{ secrets.REDIS_URL }}" \
            -e SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            --health-cmd="curl -f http://localhost:3000/api/health || exit 1" \
            --health-interval=30s \
            --health-timeout=10s \
            --health-retries=3 \
            --health-start-period=60s \
            $IMAGE_TAG
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "â³ Waiting for container to be healthy..."
          sleep 10
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          docker ps | grep $CONTAINER_NAME
          
          # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          echo "ðŸ—„ï¸ Running database migrations..."
          docker exec $CONTAINER_NAME npx prisma db push || true
          
          # æ¸…ç†æ—§é•œåƒ
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          # å¥åº·æ£€æŸ¥
          echo "ðŸ¥ Performing health check..."
          sleep 5
          curl -f http://localhost:3000/api/health || exit 1
          
          echo "âœ… Deployment completed successfully!"
          
    - name: ðŸ” Verify Deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          docker ps | grep ${{ env.IMAGE_NAME }}
          
          # æ£€æŸ¥åº”ç”¨æ—¥å¿—
          docker logs --tail 50 ${{ env.IMAGE_NAME }}
          
          # æ£€æŸ¥å¥åº·çŠ¶æ€
          docker inspect ${{ env.IMAGE_NAME }} --format='{{.State.Health.Status}}'

  notify:
    name: ðŸ“¬ Notify Deployment Status
    needs: [build-and-push, deploy-to-server]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ðŸ“Š Deployment Summary
      run: |
        echo "### Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.deploy-to-server.result }}" == "success" ]]; then
          echo "âœ… **Deployment Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Application URL:** https://${{ secrets.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ³ **Image:** ${{ needs.build-and-push.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”§ **Digest:** ${{ needs.build-and-push.outputs.image-digest }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Deployment Status:** Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ‘¤ **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY