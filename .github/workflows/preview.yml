name: ğŸŒ¿ Preview Deployment

on:
  pull_request:
    branches: [ main, master ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'develop'

env:
  NODE_VERSION: "18"

jobs:
  # Build Preview
  build-preview:
    name: ğŸ—ï¸ Build Preview
    runs-on: ubuntu-latest
    
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ—„ï¸ Generate Prisma Client
      run: npx prisma generate
      
    - name: ğŸ”¨ Build for Preview
      run: npm run build
      env:
        DATABASE_URL: "postgresql://preview:preview@localhost:5432/preview"
        NODE_ENV: "production"
        
    - name: ğŸ“¦ Create Deployment Package
      run: |
        mkdir -p preview-package
        cp -r .next preview-package/
        cp -r public preview-package/
        cp -r prisma preview-package/
        cp package.json preview-package/
        cp next.config.js preview-package/
        
    - name: ğŸš€ Deploy to Preview Environment
      id: deploy
      run: |
        # è¿™é‡Œå¯ä»¥é›†æˆåˆ°ä½ çš„é¢„è§ˆç¯å¢ƒ
        # æ¯”å¦‚ Vercel Preview, Netlify Deploy Preview, æˆ–è‡ªå®šä¹‰ç¯å¢ƒ
        
        echo "ğŸŒŸ Deploying to preview environment..."
        
        # ç¤ºä¾‹ï¼šéƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨çš„å­ç›®å½•
        PREVIEW_ID="pr-${{ github.event.number || github.ref_name }}"
        PREVIEW_URL="https://preview.yourdomain.com/${PREVIEW_ID}"
        
        echo "preview-url=${PREVIEW_URL}" >> $GITHUB_OUTPUT
        echo "preview-id=${PREVIEW_ID}" >> $GITHUB_OUTPUT
        
        echo "âœ… Preview deployed to: ${PREVIEW_URL}"

  # Run E2E Tests on Preview
  e2e-tests:
    name: ğŸ§ª E2E Tests
    needs: build-preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ­ Install Playwright
      run: |
        if npm list @playwright/test --depth=0 2>/dev/null; then
          npx playwright install --with-deps
        else
          echo "Installing Playwright for E2E testing..."
          npm install --save-dev @playwright/test
          npx playwright install --with-deps
        fi
        
    - name: ğŸƒ Run E2E Tests
      run: |
        # åˆ›å»ºåŸºç¡€çš„E2Eæµ‹è¯•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "playwright.config.js" ]; then
          echo "Creating basic Playwright configuration..."
          cat > playwright.config.js << 'EOF'
        import { defineConfig, devices } from '@playwright/test';

        export default defineConfig({
          testDir: './e2e',
          fullyParallel: true,
          forbidOnly: !!process.env.CI,
          retries: process.env.CI ? 2 : 0,
          workers: process.env.CI ? 1 : undefined,
          reporter: 'html',
          use: {
            baseURL: process.env.PREVIEW_URL || 'http://localhost:3000',
            trace: 'on-first-retry',
          },
          projects: [
            {
              name: 'chromium',
              use: { ...devices['Desktop Chrome'] },
            },
          ],
          webServer: {
            command: 'npm run start',
            port: 3000,
            reuseExistingServer: !process.env.CI,
          },
        });
        EOF
        fi
        
        # åˆ›å»ºåŸºç¡€çš„E2Eæµ‹è¯•
        mkdir -p e2e
        if [ ! -f "e2e/basic.spec.js" ]; then
          cat > e2e/basic.spec.js << 'EOF'
        const { test, expect } = require('@playwright/test');

        test.describe('Basic Application Tests', () => {
          test('homepage loads successfully', async ({ page }) => {
            await page.goto('/');
            await expect(page).toHaveTitle(/AI Galaxy|AI Agent/i);
          });

          test('navigation works', async ({ page }) => {
            await page.goto('/');
            
            // æ£€æŸ¥åŸºæœ¬å¯¼èˆªå…ƒç´ 
            const navigation = page.locator('nav, .nav, [role="navigation"]');
            if (await navigation.isVisible()) {
              await expect(navigation).toBeVisible();
            }
          });

          test('admin page is accessible', async ({ page }) => {
            await page.goto('/admin');
            // åº”è¯¥é‡å®šå‘åˆ°ç™»å½•é¡µé¢æˆ–æ˜¾ç¤ºç®¡ç†ç•Œé¢
            await expect(page).toHaveURL(/\/admin|\/login/);
          });
        });
        EOF
        fi
        
        # è¿è¡Œæµ‹è¯•
        if [ "${{ needs.build-preview.outputs.preview-url }}" != "" ]; then
          PREVIEW_URL="${{ needs.build-preview.outputs.preview-url }}" npx playwright test
        else
          echo "Preview URL not available, running against local server"
          npm run dev &
          sleep 10
          npx playwright test
          pkill -f "next dev" || true
        fi
      env:
        PREVIEW_URL: ${{ needs.build-preview.outputs.preview-url }}
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Performance Testing
  performance-test:
    name: âš¡ Performance Test
    needs: build-preview
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸš€ Install Lighthouse CI
      run: |
        npm install -g @lhci/cli@0.12.x
        
    - name: âš¡ Run Lighthouse CI
      run: |
        # åˆ›å»ºLighthouseé…ç½®
        cat > lighthouserc.js << 'EOF'
        module.exports = {
          ci: {
            collect: {
              url: [
                process.env.PREVIEW_URL || 'http://localhost:3000',
                (process.env.PREVIEW_URL || 'http://localhost:3000') + '/admin'
              ],
              startServerCommand: 'npm run start',
              numberOfRuns: 3,
            },
            assert: {
              assertions: {
                'categories:performance': ['warn', { minScore: 0.7 }],
                'categories:accessibility': ['error', { minScore: 0.9 }],
                'categories:best-practices': ['warn', { minScore: 0.8 }],
                'categories:seo': ['warn', { minScore: 0.8 }],
              },
            },
            upload: {
              target: 'temporary-public-storage',
            },
          },
        };
        EOF
        
        if [ "${{ needs.build-preview.outputs.preview-url }}" != "" ]; then
          PREVIEW_URL="${{ needs.build-preview.outputs.preview-url }}" lhci autorun
        else
          echo "Running Lighthouse against local server"
          lhci autorun
        fi
      env:
        PREVIEW_URL: ${{ needs.build-preview.outputs.preview-url }}

  # Update PR with Results
  update-pr:
    name: ğŸ“ Update PR
    needs: [build-preview, e2e-tests, performance-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && always()
    
    steps:
    - name: ğŸ“ Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // æŸ¥æ‰¾ä¹‹å‰çš„é¢„è§ˆè¯„è®º
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ğŸŒ¿ Preview Deployment')
          );
          
          const previewUrl = '${{ needs.build-preview.outputs.preview-url }}';
          const e2eStatus = '${{ needs.e2e-tests.result }}';
          const perfStatus = '${{ needs.performance-test.result }}';
          
          const body = `## ğŸŒ¿ Preview Deployment
          
          ### ğŸš€ Deployment Status
          ${previewUrl ? `âœ… **Preview URL:** [${previewUrl}](${previewUrl})` : 'âŒ **Preview deployment failed**'}
          
          ### ğŸ§ª Test Results
          - **E2E Tests:** ${e2eStatus === 'success' ? 'âœ… Passed' : e2eStatus === 'failure' ? 'âŒ Failed' : 'â³ Skipped'}
          - **Performance Tests:** ${perfStatus === 'success' ? 'âœ… Passed' : perfStatus === 'failure' ? 'âŒ Failed' : 'â³ Skipped'}
          
          ### ğŸ“Š Quick Actions
          - ğŸ” [View Checks](${context.payload.pull_request.html_url}/checks)
          - ğŸ­ [E2E Test Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          
          ---
          *Updated at: ${new Date().toISOString()}*
          *Commit: ${context.sha.substring(0, 7)}*
          `;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }