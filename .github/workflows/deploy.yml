name: ğŸš€ Deploy AI Agent Platform

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    name: ğŸŒ Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“‚ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: npm ci
      
    - name: ğŸ”¨ Build Application
      run: npm run build
      
    - name: ğŸ—„ï¸ Generate Prisma Client
      run: npx prisma generate
      
    - name: ğŸ“‹ Create Deployment Package
      run: |
        mkdir -p deploy-package
        cp -r .next deploy-package/
        cp -r public deploy-package/
        cp -r prisma deploy-package/
        cp -r components deploy-package/
        cp -r app deploy-package/
        cp -r lib deploy-package/ || true
        cp package.json deploy-package/
        cp package-lock.json deploy-package/
        cp next.config.js deploy-package/
        cp tailwind.config.js deploy-package/
        cp tsconfig.json deploy-package/
        cp ecosystem.config.js deploy-package/
        cp .env.production deploy-package/
        
    - name: ğŸš€ Deploy to Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /www/wwwroot/mpai.openpenpal.com
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d "backup-$(date +%Y%m%d)" ]; then
            rm -rf "backup-$(date +%Y%m%d)"
          fi
          mkdir -p "backup-$(date +%Y%m%d)"
          cp -r .next "backup-$(date +%Y%m%d)/" 2>/dev/null || true
          
          # ä» GitHub æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main || git pull origin master
          
          # å®‰è£…ä¾èµ–
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --only=production --silent
          
          # æ„å»ºåº”ç”¨
          echo "ğŸ”¨ Building application..."
          npm run build
          
          # ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
          echo "ğŸ—„ï¸ Generating Prisma client..."
          npx prisma generate
          
          # æ•°æ®åº“è¿ç§»ï¼ˆå®‰å…¨çš„ï¼‰
          echo "ğŸ”„ Database migration..."
          npx prisma db push
          
          # è®¾ç½®æƒé™
          echo "ğŸ” Setting permissions..."
          chown -R www:www /www/wwwroot/mpai.openpenpal.com
          chmod -R 755 /www/wwwroot/mpai.openpenpal.com
          
          # é‡å¯ PM2 åº”ç”¨
          echo "ğŸ”„ Restarting application..."
          pm2 reload ai-agent-platform || pm2 start ecosystem.config.js
          
          # æ£€æŸ¥åº”ç”¨çŠ¶æ€
          echo "ğŸ“Š Checking application status..."
          sleep 3
          pm2 status ai-agent-platform
          
          echo "âœ… Deployment completed successfully!"
          
    - name: ğŸ” Health Check
      run: |
        echo "ğŸ¥ Performing health check..."
        sleep 10
        curl -f https://mpai.openpenpal.com || exit 1
        echo "âœ… Health check passed!"
        
    - name: ğŸ“¬ Notify Success
      if: success()
      run: |
        echo "ğŸ‰ Deployment to production completed successfully!"
        echo "ğŸŒ Site: https://mpai.openpenpal.com"
        echo "âš™ï¸ Admin: https://mpai.openpenpal.com/admin"